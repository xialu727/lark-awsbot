# 飞书AWS工单机器人使用说明

## 📖 概述

基于模块化架构的飞书AWS工单机器人，支持通过飞书快速创建和管理AWS工单，并自动创建讨论群聊进行团队协作。

## 🚀 快速开始

### 1. 部署应用

```bash
# 使用部署脚本（推荐）
chmod +x deploy-serverless.sh
./deploy-serverless.sh

# 或手动部署
sam build && sam deploy --guided
```

### 2. 配置飞书应用

在[飞书开发者平台](https://open.feishu.cn/app)配置：

**事件订阅URL：**
```
https://your-api-gateway-url/webhook
```

**卡片回调URL：**
```
https://your-api-gateway-url/card_action
```

**必需权限：**
- `im:message` - 发送和接收消息
- `im:message:send_as_bot` - 以机器人身份发送消息
- `im:chat` - 获取群组信息
- `im:chat:create` - 创建群聊（核心功能）
- `im:chat:member` - 管理群成员
- `contact:user.id:readonly` - 获取用户ID

## 💬 使用方法

### 基本命令

| 命令 | 格式 | 说明 |
|------|------|------|
| 创建工单 | `开工单 [标题]` | 创建新的AWS工单 |
| 添加内容 | `内容 [详细描述]` | 为工单添加详细信息 |
| 查看历史 | `历史` | 查看历史工单列表 |
| 获取帮助 | `帮助` | 显示帮助信息 |

### 工单创建流程

1. **发起工单**
   ```
   开工单 EC2实例无法启动
   ```

2. **选择配置**
   - 机器人返回交互卡片
   - 选择服务类型和严重级别
   - 点击「提交」按钮

3. **自动处理**
   - ✅ 创建AWS Support工单
   - ✅ 创建飞书讨论群聊
   - ✅ 邀请创建者加入群聊
   - ✅ 发送工单基本信息到群聊

4. **添加详情**
   ```
   内容 实例ID: i-1234abcd，错误信息：Instance failed to start
   ```

## 🔧 群聊协作功能

### 自动群聊创建
- **群聊命名**：`AWS工单-[工单ID]`
- **成员管理**：工单创建者自动成为群主
- **信息同步**：工单信息自动发送到群聊
- **协作讨论**：团队成员可在群聊中讨论工单进展

### 历史查询
通过「历史」命令查看：
- 工单基本信息
- 对应群聊链接
- 工单状态和进展

## 🛠️ 故障排除

### 查看日志
```bash
# 查看Lambda函数日志
sam logs -n LarkBotFunction --stack-name lark-aws-bot --tail

# 查看特定时间段日志
sam logs -n LarkBotFunction --stack-name lark-aws-bot --start-time '10min ago'
```

### 常见问题

**1. 机器人无响应**
- 检查飞书应用权限配置
- 验证事件订阅URL是否正确
- 查看Lambda函数日志

**2. 无法创建群聊**
- 确认已配置 `im:chat:create` 权限
- 检查飞书应用是否已发布并通过审核

**3. AWS工单创建失败**
- 验证Lambda函数的IAM权限
- 检查AWS Support API访问权限
- 确认DynamoDB表是否存在

### 权限检查

确保Lambda函数具有以下AWS权限：
- `dynamodb:GetItem`、`dynamodb:PutItem`、`dynamodb:Query`
- `support:CreateCase`、`support:DescribeCases`
- `logs:CreateLogGroup`、`logs:CreateLogStream`、`logs:PutLogEvents`

## 🔄 更新部署

修改代码后重新部署：
```bash
sam build && sam deploy

## 🆘 技术支持

如遇问题，请：
1. 查看CloudWatch日志获取详细错误信息
2. 检查配置是否正确
3. 参考故障排除章节
4. 提交Issue描述具体问题